<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary Meta Tags -->
    <title>Free Snapchat Memories Downloader - Save Before Snapchat Charges | No Upload Required</title>
    <meta name="title" content="Free Snapchat Memories Downloader - Save Before Snapchat Charges | No Upload Required">
    <meta name="description" content="100% free tool to download all your Snapchat memories with metadata before Snapchat starts charging. No upload required - runs entirely in your browser. Free alternative to ExportSnaps ($15). Preserve your photos, videos, and GPS data safely.">
    <meta name="keywords" content="snapchat memories downloader, free snapchat backup, save snapchat memories, snapchat charging for storage, exportsnaps alternative, free exportsnaps, download snapchat photos, snapchat metadata, private snapchat downloader, local snapchat backup, snapchat memories free, browser-based snapchat downloader, no upload snapchat, preserve snapchat memories">
    <meta name="author" content="andrefecto">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://andrefecto.github.io/Snapchat-Memories-Downloader/">
    <meta property="og:title" content="Free Snapchat Memories Downloader - Save Before Snapchat Charges">
    <meta property="og:description" content="100% free tool to download all your Snapchat memories before they start charging. No upload required - completely private and runs in your browser. Free alternative to ExportSnaps.">
    <meta property="og:image" content="https://andrefecto.github.io/Snapchat-Memories-Downloader/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://andrefecto.github.io/Snapchat-Memories-Downloader/">
    <meta property="twitter:title" content="Free Snapchat Memories Downloader - Save Before Snapchat Charges">
    <meta property="twitter:description" content="100% free tool to download all your Snapchat memories. No upload required - runs entirely in your browser. Save before Snapchat starts charging!">
    <meta property="twitter:image" content="https://andrefecto.github.io/Snapchat-Memories-Downloader/og-image.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://andrefecto.github.io/Snapchat-Memories-Downloader/">

    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Snapchat Memories Downloader",
      "applicationCategory": "UtilityApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Free tool to download all your Snapchat memories with metadata. No upload required - runs entirely in your browser. Save your photos and videos before Snapchat starts charging for storage.",
      "author": {
        "@type": "Person",
        "name": "andrefecto",
        "url": "https://github.com/andrefecto"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5",
        "ratingCount": "1"
      }
    }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 4px;
        }

        .warning strong {
            color: #856404;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #e8eaff;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            display: none;
            margin-top: 25px;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .status {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.error {
            color: #dc3545;
        }

        .log-entry.info {
            color: #666;
        }

        .features {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }

        .features h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .features ul {
            list-style: none;
            padding-left: 0;
        }

        .features li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .features li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }

        .footer-links {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .footer-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin: 0 10px;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        .coffee-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #FFDD00;
            color: #000;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(255, 221, 0, 0.3);
        }

        .coffee-btn:hover {
            background: #FFED4E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 221, 0, 0.4);
            text-decoration: none;
        }

        .github-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #24292e;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(36, 41, 46, 0.3);
        }

        .github-badge:hover {
            background: #2f363d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(36, 41, 46, 0.4);
            text-decoration: none;
            color: white;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 4px;
        }

        .info-box h3 {
            margin-top: 0;
            color: #667eea;
        }

        .info-box ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .info-box li {
            margin: 8px 0;
        }

        .info-box a {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Free Snapchat Memories Downloader</h1>
        <p class="subtitle">Save ALL your Snapchat memories before they start charging for storage - 100% FREE & Private</p>

        <div class="warning" style="background: #fff3cd; border-color: #ffc107;">
            <strong>‚ö†Ô∏è Snapchat is Charging for Storage Soon!</strong> Download your memories now for FREE. Don't pay $15 to other services like ExportSnaps - this tool is 100% free and safer because your data never leaves your browser.
        </div>

        <div class="warning">
            <strong>üîí Privacy First:</strong> Your data never leaves your browser. Everything is processed locally on your device. No upload required - completely offline processing.
        </div>

        <div class="info-box">
            <h3>üì• First Time? Get Your Snapchat Data</h3>
            <p>Before using this tool, you need to download your data from Snapchat:</p>
            <ol>
                <li><strong>Login</strong> to <a href="https://accounts.snapchat.com/" target="_blank">Snapchat's website</a></li>
                <li>Click the <strong>menu</strong> in the top left corner
                    <ul style="list-style: none; padding-left: 15px; margin: 5px 0;">
                        <li>Mobile: Tap "Accounts"</li>
                        <li>Desktop: Click "Account Settings"</li>
                    </ul>
                </li>
                <li>Click <strong>"My Data"</strong></li>
                <li>Select the data you want:
                    <ul style="list-style: none; padding-left: 15px; margin: 5px 0;">
                        <li>‚úÖ <strong>Memories</strong> (required for this tool)</li>
                        <li>‚úÖ <strong>Chat Media</strong> (optional - now separate)</li>
                        <li>‚úÖ <strong>Shared Stories</strong> (optional - now separate)</li>
                    </ul>
                </li>
                <li>Click <strong>"Submit Request"</strong></li>
                <li>Wait for Snapchat to email you (24-48 hours)</li>
                <li>Download the ZIP and extract it</li>
                <li>Find <code>memories_history.html</code> in the <code>html/</code> folder</li>
            </ol>
            <p style="font-size: 14px; margin-top: 15px;">
                <a href="https://www.reddit.com/r/techsupport/comments/18mkfvv/is_there_a_way_of_exporting_all_snapchat/" target="_blank">More info on Reddit</a>
            </p>
        </div>

        <div class="upload-section" id="uploadSection">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" style="margin-bottom: 15px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <h3 style="margin-bottom: 10px;">Upload memories_history.html</h3>
            <p style="color: #666; margin-bottom: 20px;">Drag and drop or click to browse</p>
            <input type="file" id="fileInput" accept=".html">
            <label for="fileInput" class="btn">Choose HTML File</label>
            <p id="fileName" style="margin-top: 15px; color: #667eea; font-weight: 600;"></p>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                <h4 style="margin-bottom: 10px; font-size: 16px;">Resume/Retry (Optional)</h4>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Upload metadata.json to resume or retry failed downloads</p>
                <input type="file" id="metadataInput" accept=".json">
                <label for="metadataInput" class="btn" style="background: #28a745;">Choose metadata.json</label>
                <p id="metadataFileName" style="margin-top: 10px; color: #28a745; font-weight: 600;"></p>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="status" id="status">Preparing download...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="log" id="log"></div>
        </div>

        <div class="features">
            <h2>Why Use This Free Tool?</h2>
            <ul>
                <li><strong>100% FREE</strong> - Don't pay $15 to ExportSnaps or other services</li>
                <li><strong>Save Before Snapchat Charges</strong> - Download now before storage fees kick in</li>
                <li><strong>Completely Private</strong> - No upload required, runs in your browser offline</li>
                <li><strong>Preserves Everything</strong> - GPS coordinates, dates, and all metadata intact</li>
                <li><strong>Handles Overlays</strong> - Extracts both main and overlay files from edited snaps</li>
                <li><strong>Resume Support</strong> - Pick up where you left off if interrupted</li>
                <li><strong>Safe & Secure</strong> - Your memories never leave your computer</li>
                <li><strong>One-Click Download</strong> - Get everything in a convenient ZIP file</li>
            </ul>
        </div>

        <div class="features">
            <h2>Frequently Asked Questions</h2>
            <div style="text-align: left; padding-left: 20px;">
                <h3 style="margin-top: 20px; color: #667eea;">Is this really free?</h3>
                <p>Yes! 100% free, forever. No hidden costs, no premium features. We built this to help people save their memories before Snapchat starts charging.</p>

                <h3 style="margin-top: 20px; color: #667eea;">Is it safe? Do you upload my photos?</h3>
                <p>Completely safe. Your photos and videos never leave your computer. Everything runs in your browser - no server uploads, no cloud processing. Unlike paid services, your data stays 100% private.</p>

                <h3 style="margin-top: 20px; color: #667eea;">How is this different from ExportSnaps?</h3>
                <p>ExportSnaps charges $15 and requires you to upload your data to their servers. This tool is FREE and runs entirely on your computer - your data never leaves your device.</p>

                <h3 style="margin-top: 20px; color: #667eea;">Will this work if Snapchat starts charging?</h3>
                <p>Yes! This downloads your memories from Snapchat's data export, which will always be available regardless of storage fees. Download now to avoid future charges.</p>

                <h3 style="margin-top: 20px; color: #667eea;">Does it preserve GPS location data?</h3>
                <p>Yes! All metadata is preserved including GPS coordinates, dates, and media types. Perfect for backing up your memories with all their original information.</p>

                <h3 style="margin-top: 20px; color: #667eea;">What if the download fails or gets interrupted?</h3>
                <p>No problem! Simply upload your metadata.json file (included in the ZIP) and it will resume from where you left off. All progress is saved.</p>

                <h3 style="margin-top: 20px; color: #667eea;">Can I download Chat Media and Shared Stories too?</h3>
                <p>Yes! When requesting your data from Snapchat, select "Chat Media" and "Shared Stories" in addition to "Memories". This tool works with all of them.</p>
            </div>
        </div>

        <div class="footer-links">
            <div style="margin-bottom: 15px;">
                <a class="github-badge" href="https://github.com/andrefecto" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    andrefecto
                </a>
            </div>
            <div style="margin-bottom: 15px;">
                <a class="coffee-btn" href="https://buymeacoffee.com/andrefecto" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z"/>
                    </svg>
                    Buy Me a Coffee
                </a>
            </div>
            <div style="color: #666; font-size: 14px;">
                <a href="https://github.com/andrefecto/snapchat-memories-downloader" target="_blank">
                    View Source on GitHub
                </a> |
                <a href="https://github.com/andrefecto/snapchat-memories-downloader#python-script" target="_blank">
                    Python Script Version
                </a>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const metadataInput = document.getElementById('metadataInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileName = document.getElementById('fileName');
        const metadataFileName = document.getElementById('metadataFileName');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const status = document.getElementById('status');
        const log = document.getElementById('log');

        let memories = [];
        let existingMetadata = null;
        let currentIndex = 0;
        let zip = null;

        // Drag and drop handlers
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        metadataInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                metadataFileName.textContent = file.name;
                try {
                    const text = await file.text();
                    existingMetadata = JSON.parse(text);
                    addLog(`Loaded metadata.json with ${existingMetadata.length} entries`, 'success');
                } catch (error) {
                    addLog(`Error loading metadata.json: ${error.message}`, 'error');
                    existingMetadata = null;
                }
            }
        });

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressFill.style.width = `${percent}%`;
            progressFill.textContent = `${percent}%`;
            status.textContent = `Processing ${current} of ${total} memories...`;
        }

        async function handleFile(file) {
            if (!file.name.endsWith('.html')) {
                alert('Please upload an HTML file');
                return;
            }

            fileName.textContent = file.name;
            addLog('Reading file...', 'info');

            const text = await file.text();
            parseHTML(text);
        }

        function parseHTML(htmlText) {
            addLog('Parsing HTML...', 'info');

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const rows = doc.querySelectorAll('tr');

            memories = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const dateCell = cells[0].textContent.trim();
                    const typeCell = cells[1].textContent.trim();
                    const locationCell = cells[2].textContent.trim();
                    const link = cells[3].querySelector('a');

                    if (dateCell.includes('UTC') && link) {
                        const onclickAttr = link.getAttribute('onclick');
                        const urlMatch = onclickAttr ? onclickAttr.match(/downloadMemories\('([^']+)'/) : null;

                        if (urlMatch) {
                            const locationMatch = locationCell.match(/Latitude, Longitude:\s*([-\d.]+),\s*([-\d.]+)/);

                            memories.push({
                                date: dateCell,
                                mediaType: typeCell,
                                latitude: locationMatch ? locationMatch[1] : 'Unknown',
                                longitude: locationMatch ? locationMatch[2] : 'Unknown',
                                url: urlMatch[1]
                            });
                        }
                    }
                }
            });

            if (memories.length === 0) {
                addLog('No memories found in file!', 'error');
                alert('No memories found in the HTML file. Please make sure you uploaded the correct memories_history.html file.');
                return;
            }

            addLog(`Found ${memories.length} memories`, 'success');
            progressContainer.style.display = 'block';

            startDownload();
        }

        async function startDownload() {
            zip = new JSZip();
            currentIndex = 0;

            // Initialize or use existing metadata
            let metadataList = existingMetadata || [];

            // If no existing metadata, create new entries with pending status
            if (!existingMetadata) {
                for (let i = 0; i < memories.length; i++) {
                    const memory = memories[i];
                    metadataList.push({
                        number: i + 1,
                        date: memory.date,
                        media_type: memory.mediaType,
                        latitude: memory.latitude,
                        longitude: memory.longitude,
                        url: memory.url,
                        status: 'pending',
                        files: []
                    });
                }
                addLog('Initialized metadata for all memories', 'info');
            } else {
                addLog('Using existing metadata - will skip successful downloads', 'info');
            }

            // Determine which items to download (pending or failed)
            const itemsToDownload = metadataList.map((m, i) => ({ metadata: m, index: i }))
                .filter(item => item.metadata.status !== 'success' || !item.metadata.files || item.metadata.files.length === 0);

            addLog(`${itemsToDownload.length} items to download (${metadataList.length - itemsToDownload.length} already completed)`, 'info');

            if (itemsToDownload.length === 0) {
                addLog('All memories already downloaded!', 'success');
                status.textContent = 'All downloads complete!';
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                return;
            }

            for (let count = 0; count < itemsToDownload.length; count++) {
                const { metadata, index: i } = itemsToDownload[count];
                const memory = memories[i];
                const fileNum = String(metadata.number).padStart(2, '0');
                const extension = metadata.media_type === 'Video' ? '.mp4' : '.jpg';

                updateProgress(count + 1, itemsToDownload.length);
                addLog(`[${count + 1}/${itemsToDownload.length}] #${metadata.number} ${metadata.date} - ${metadata.media_type}`, 'info');

                // Mark as in progress
                metadata.status = 'in_progress';

                try {
                    const response = await fetch(metadata.url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();

                    // Check if it's a ZIP file (overlay content)
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const isZip = uint8Array[0] === 0x50 && uint8Array[1] === 0x4B;

                    // Reset files array
                    metadata.files = [];

                    if (isZip) {
                        // Extract ZIP contents
                        const innerZip = await JSZip.loadAsync(arrayBuffer);
                        const files = Object.keys(innerZip.files);

                        for (const filename of files) {
                            const fileData = await innerZip.files[filename].async('arraybuffer');
                            const isOverlay = filename.toLowerCase().includes('-overlay');
                            const newFilename = isOverlay
                                ? `${fileNum}-overlay${extension}`
                                : `${fileNum}-main${extension}`;

                            zip.file(newFilename, fileData);
                            metadata.files.push({
                                path: newFilename,
                                size: fileData.byteLength,
                                type: isOverlay ? 'overlay' : 'main'
                            });
                        }
                        addLog(`  Extracted ${files.length} files from ZIP`, 'success');
                    } else {
                        // Regular file
                        const filename = `${fileNum}${extension}`;
                        zip.file(filename, arrayBuffer);
                        metadata.files.push({
                            path: filename,
                            size: arrayBuffer.byteLength,
                            type: 'single'
                        });
                        addLog(`  Downloaded: ${filename} (${formatBytes(arrayBuffer.byteLength)})`, 'success');
                    }

                    // Mark as successful
                    metadata.status = 'success';
                    delete metadata.error;  // Remove any previous error

                } catch (error) {
                    addLog(`  ERROR: ${error.message}`, 'error');
                    metadata.status = 'failed';
                    metadata.error = error.message;
                }

                // Small delay to prevent overwhelming the browser
                if (count % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            // Add metadata.json to zip
            zip.file('metadata.json', JSON.stringify(metadataList, null, 2));

            // Generate and download ZIP
            status.textContent = 'Creating ZIP file...';
            addLog('Packaging files into ZIP...', 'info');

            const zipBlob = await zip.generateAsync({ type: 'blob' }, (metadata) => {
                const percent = Math.round(metadata.percent);
                progressFill.style.width = `${percent}%`;
                progressFill.textContent = `${percent}%`;
            });

            // Download the ZIP file
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'snapchat-memories.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            status.textContent = 'Complete! ZIP file downloaded.';

            // Calculate statistics
            const successful = metadataList.filter(m => m.status === 'success').length;
            const failed = metadataList.filter(m => m.status === 'failed').length;
            const pending = metadataList.filter(m => m.status === 'pending').length;

            addLog(`Successfully processed ${itemsToDownload.length} items!`, 'success');
            addLog(`Total: ${successful} successful, ${failed} failed, ${pending} pending`, 'info');
            addLog(`Check your Downloads folder for snapchat-memories.zip`, 'success');

            if (failed > 0 || pending > 0) {
                addLog(`Tip: Download the metadata.json from the ZIP and re-upload it to retry failed/pending items`, 'info');
            }

            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
